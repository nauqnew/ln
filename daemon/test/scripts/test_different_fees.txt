wen@ubuntu:~$ cd lightning/
wen@ubuntu:~/lightning$ cd daemon/test
wen@ubuntu:~/lightning/daemon/test$ . scripts/vars.sh
wen@ubuntu:~/lightning/daemon/test$ . scripts/helpers.sh
wen@ubuntu:~/lightning/daemon/test$ parse_cmdline 2 "$@" --verbose
wen@ubuntu:~/lightning/daemon/test$ setup_lightning 2
wen@ubuntu:~/lightning/daemon/test$ DEFAULT_FEE_RATE2=50000
wen@ubuntu:~/lightning/daemon/test$ FEE_RATE2=$(($DEFAULT_FEE_RATE2 * 5))
wen@ubuntu:~/lightning/daemon/test$ echo "default-fee-rate=$DEFAULT_FEE_RATE2" >> $DIR2/config
wen@ubuntu:~/lightning/daemon/test$ start_lightningd 2
Starting bitcoind...
        { "type" : "INFO", "time" : "0.124566755", "source" : "lightningd(3151):", "log" : "Hello world!" },
        { "type" : "INFO", "time" : "0.125341682", "source" : "lightningd(3156):", "log" : "Hello world!" },
[
  "2edc3440883e0d0005c53cd51e16870568d550925bc5eff46a4a1c7b6443201c"
]
wen@ubuntu:~/lightning/daemon/test$ lcli1 connect localhost $PORT2 $FUND_INPUT_TX &
[1] 3233
wen@ubuntu:~/lightning/daemon/test$ ../lightning-cli --lightning-dir=/tmp/lightning.3059.1 connect localhost 4000 0100000001612a3f6ba3627ed92269d3085b2f5856d23e7e3cf9287cefe4436351acefaf4f010000006b483045022100e4239dc047873fc3b98a6c9f661c86ee4291f1b97be3a6be9f6d7ee27fae2d0102201d69f314ab2a1e76276edca3c3d766df2adf92468d09d0f77bfc8f2c639b8ada01210301936549bfc33e7bb957885e48284ff599e5d3a8969432b3d9b5713f672dc3c2feffffff0240420f000000000017a9144d5e62abae66ba5957d5f2be467314c91f1247e48794d7624a000000001976a9146513e163ce1cdc2bf4bb1080cd854028d09ced7c88acb1010000

wen@ubuntu:~/lightning/daemon/test$ check_tx_spend
  "01615107819848fe69e6d8ae6eac3e9d77d44eae573e5fcbb2089f33f92c4f38"
wen@ubuntu:~/lightning/daemon/test$ $CLI generate 1
[
  "69e8aae5385589a0accf1a78db39e5c387a50f7cc77d3ac2c5f631c3199400b9"
]
wen@ubuntu:~/lightning/daemon/test$ { "id" : "0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47" }

[1]+  Done                    lcli1 connect localhost $PORT2 $FUND_INPUT_TX
wen@ubuntu:~/lightning/daemon/test$ DO_RECONNECT=$RECONNECT
wen@ubuntu:~/lightning/daemon/test$ check_peerstate lcli1 STATE_NORMAL
../lightning-cli --lightning-dir=/tmp/lightning.3059.1 getpeers
        { "name" : "0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47:", "state" : "STATE_NORMAL", "peerid" : "0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47", "connected" : true, "our_amount" : 924280000, "our_fee" : 67600000, "their_amount" : 0, "their_fee" : 0, "our_htlcs" :
wen@ubuntu:~/lightning/daemon/test$ check_peerstate lcli2 STATE_NORMAL
../lightning-cli --lightning-dir=/tmp/lightning.3059.2 getpeers
        { "name" : "0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500:", "state" : "STATE_NORMAL", "peerid" : "0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500", "connected" : true, "our_amount" : 0, "our_fee" : 0, "their_amount" : 907380000, "their_fee" : 84500000, "our_htlcs" :
wen@ubuntu:~/lightning/daemon/test$ NO_HTLCS_FEE2=$((338 * $FEE_RATE2 / 2000 * 2000))
wen@ubuntu:~/lightning/daemon/test$ ONE_HTLCS_FEE2=$(( (338 + 32) * $FEE_RATE2 / 2000 * 2000))
wen@ubuntu:~/lightning/daemon/test$ echo $NO_HTLCS_FEE2
84500000
wen@ubuntu:~/lightning/daemon/test$ echo $ONE_HTLCS_FEE2
92500000
wen@ubuntu:~/lightning/daemon/test$ A_AMOUNT1=$(($AMOUNT - $NO_HTLCS_FEE))
wen@ubuntu:~/lightning/daemon/test$ echo $A_AMOUNT

wen@ubuntu:~/lightning/daemon/test$ echo $A_AMOUNT1
924280000
wen@ubuntu:~/lightning/daemon/test$ A_FEE1=$NO_HTLCS_FEE
wen@ubuntu:~/lightning/daemon/test$ echo $A_FEE1
67600000
wen@ubuntu:~/lightning/daemon/test$ A_AMOUNT2=$(($AMOUNT - $NO_HTLCS_FEE2))
wen@ubuntu:~/lightning/daemon/test$ echo $A_AMOUNT2
907380000
wen@ubuntu:~/lightning/daemon/test$ A_FEE2=$NO_HTLCS_FEE2
wen@ubuntu:~/lightning/daemon/test$ B_AMOUNT=0
wen@ubuntu:~/lightning/daemon/test$ B_FEE=0
wen@ubuntu:~/lightning/daemon/test$ check_status_single lcli1 $A_AMOUNT1 $A_FEE1 "" $B_AMOUNT $B_FEE ""
../lightning-cli --lightning-dir=/tmp/lightning.3059.1 getpeers
{ peers : [ { name : 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47: , state : STATE_NORMAL , peerid : 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47 , connected : true, our_amount : 924280000, our_fee : 67600000, their_amount : 0, their_fee : 0, our_htlcs : [ ], their_htlcs : [ ] } ] }
../lightning-cli --lightning-dir=/tmp/lightning.3059.1 getpeers
{ peers : [ { name : 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47: , state : STATE_NORMAL , peerid : 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47 , connected : true, our_amount : 924280000, our_fee : 67600000, their_amount : 0, their_fee : 0, our_htlcs : [ ], their_htlcs : [ ] } ] }
wen@ubuntu:~/lightning/daemon/test$ check_status_single lcli2 $B_AMOUNT $B_FEE "" $(($A_AMOUNT2)) $(($A_FEE2)) ""
../lightning-cli --lightning-dir=/tmp/lightning.3059.2 getpeers
{ peers : [ { name : 0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500: , state : STATE_NORMAL , peerid : 0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500 , connected : true, our_amount : 0, our_fee : 0, their_amount : 907380000, their_fee : 84500000, our_htlcs : [ ], their_htlcs : [ ] } ] }
../lightning-cli --lightning-dir=/tmp/lightning.3059.2 getpeers
{ peers : [ { name : 0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500: , state : STATE_NORMAL , peerid : 0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500 , connected : true, our_amount : 0, our_fee : 0, their_amount : 907380000, their_fee : 84500000, our_htlcs : [ ], their_htlcs : [ ] } ] }
wen@ubuntu:~/lightning/daemon/test$ HTLC_AMOUNT=100000000
wen@ubuntu:~/lightning/daemon/test$ RHASH=`lcli2 invoice $HTLC_AMOUNT RHASH3 | sed 's/.*"\([0-9a-f]*\)".*/\1/'`
../lightning-cli --lightning-dir=/tmp/lightning.3059.2 invoice 100000000 RHASH3
wen@ubuntu:~/lightning/daemon/test$ echo $RHASH
5cca6d498b6047b370bea142568cf3ee799cf6d96aa5b0250c6952c68e616516 # =sha256(preimage)
wen@ubuntu:~/lightning/daemon/test$ ROUTE=`lcli1 getroute $ID2 $HTLC_AMOUNT 1`
../lightning-cli --lightning-dir=/tmp/lightning.3059.1 getroute 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47 100000000 1
wen@ubuntu:~/lightning/daemon/test$ ROUTE=`echo $ROUTE | sed 's/^{ "route" : \(.*\) }$/\1/'`
wen@ubuntu:~/lightning/daemon/test$ echo $ROUTE
[ { "id" : "0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47", "msatoshi" : 100000000, "delay" : 6 } ]
wen@ubuntu:~/lightning/daemon/test$ lcli1 sendpay "$ROUTE" $RHASH
../lightning-cli --lightning-dir=/tmp/lightning.3059.1 sendpay [ { "id" : "0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47", "msatoshi" : 100000000, "delay" : 6 } ] 5cca6d498b6047b370bea142568cf3ee799cf6d96aa5b0250c6952c68e616516
{ "preimage" : "c7f21e43711c95a040ea705ff899c1004d782533e14d7807e825f23305944e80" }
wen@ubuntu:~/lightning/daemon/test$ check_status_single lcli1 $(($AMOUNT - $HTLC_AMOUNT - $NO_HTLCS_FEE / 2)) $(($NO_HTLCS_FEE / 2)) "" $(($HTLC_AMOUNT - $NO_HTLCS_FEE / 2)) $(($NO_HTLCS_FEE / 2)) ""
../lightning-cli --lightning-dir=/tmp/lightning.3059.1 getpeers
{ peers : [ { name : 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47: , state : STATE_NORMAL , peerid : 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47 , connected : true, our_amount : 858080000, our_fee : 33800000, their_amount : 66200000, their_fee : 33800000, our_htlcs : [ ], their_htlcs : [ ] } ] }
../lightning-cli --lightning-dir=/tmp/lightning.3059.1 getpeers
{ peers : [ { name : 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47: , state : STATE_NORMAL , peerid : 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47 , connected : true, our_amount : 858080000, our_fee : 33800000, their_amount : 66200000, their_fee : 33800000, our_htlcs : [ ], their_htlcs : [ ] } ] }
wen@ubuntu:~/lightning/daemon/test$ check_status_single lcli2 $(($HTLC_AMOUNT - $NO_HTLCS_FEE2 / 2)) $(($NO_HTLCS_FEE2 / 2)) "" $(($AMOUNT - $HTLC_AMOUNT - $NO_HTLCS_FEE2 / 2)) $(($NO_HTLCS_FEE2 / 2)) ""
../lightning-cli --lightning-dir=/tmp/lightning.3059.2 getpeers
{ peers : [ { name : 0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500: , state : STATE_NORMAL , peerid : 0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500 , connected : true, our_amount : 57750000, our_fee : 42250000, their_amount : 849630000, their_fee : 42250000, our_htlcs : [ ], their_htlcs : [ ] } ] }
../lightning-cli --lightning-dir=/tmp/lightning.3059.2 getpeers
{ peers : [ { name : 0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500: , state : STATE_NORMAL , peerid : 0256f00677d98766532cc70353a3ac506a01c2b31eed5fbfa671bb0f8caee97500 , connected : true, our_amount : 57750000, our_fee : 42250000, their_amount : 849630000, their_fee : 42250000, our_htlcs : [ ], their_htlcs : [ ] } ] }
wen@ubuntu:~/lightning/daemon/test$ lcli1 close $ID2
../lightning-cli --lightning-dir=/tmp/lightning.3059.1 close 0241e0e953ed3e631ae9d0ab43ff97996c05e77222885d368e9cf6815689fc5b47
{  }
wen@ubuntu:~/lightning/daemon/test$ check_tx_spend
  "9ef905ffb538cd17d90bf8db03f0a4a0cc4bd25567ae9522b7f078b1925f416b"
wen@ubuntu:~/lightning/daemon/test$ $CLI generate 10
[
  "17522b53f67eebcae424371242e0f02dc7680e9bbb81bc3dd32be0f59e26b4c3",
  "660c4311daa7eb35394e1cd03933bf5cc0380e0b0f8ce8ea1fe7173498425e63",
  "7fab30ee460d96fb36e2e37da1167c21ec8acfcbaf5275afa64fa7c465604d2b",
  "5df6eb785482fe065b0118c858f36cc1fb92c024ecb1a73a99f4499005c7d346",
  "263a446f5f86335ab913077d6db20fbb9abe77a836308b0bec088c6fe6dcfe20",
  "68133c5d5e459173854a2abf8acf060706e8b9e5c98aa1def716cb4fc989b952",
  "4bb2867f849cc9b266a2e4c9693ffdbcdae37c245785ffdc30f828d0ce1722cc",
  "417ffed6257d353ce60e4192cd3dcc90b091ab3168080d1c6c679620a0899117",
  "4ccd17ef88495d074e0ba93c95ba420ebe4a88e1c21a9d0cdf179c4b448d5712",
  "555332c1c349f2d6b217aed836b4145a6102c52487843b1d99e624e341fbedc4"
]
wen@ubuntu:~/lightning/daemon/test$ check_no_peers lcli1
../lightning-cli --lightning-dir=/tmp/lightning.3059.1 getpeers
{ peers : [ ] }
wen@ubuntu:~/lightning/daemon/test$ check_no_peers lcli2
../lightning-cli --lightning-dir=/tmp/lightning.3059.2 getpeers
{ peers : [ ] }
wen@ubuntu:~/lightning/daemon/test$ $CLI getrawtransaction ^C
wen@ubuntu:~/lightning/daemon/test$ $CLI getrawtransactnion 9ef905ffb538cd17d90bf8db03f0a4a0cc4bd25567ae9522b7f078b1925f416b 1
error code: -32601
error message:
Method not found
wen@ubuntu:~/lightning/daemon/test$ $CLI getrawtransaction 9ef905ffb538cd17d90bf8db03f0a4a0cc4bd25567ae9522b7f078b1925f416b 1
{
  "hex": "02000000000101384f2cf9339f08b2cb5f3e57ae4ed4779d3eac6eaed8e669fe489881075161010000000000ffffffff02186901000000000017a914263b1d6374401a866058a8f57f8cb5448e5aa17a87607e0d000000000017a914871ad3b80984c5c1e475e9c3558b4cf0ae4d0461870400483045022100a155c81b10094e96d93c69bcd9b61699f868695f9440b7dd67120b283db73a4d02203d42780901ca8973581c77828f31d53a098fc156d9bb9eaf9975fb64fd90fb0d0148304502210099f459853ca4842620735d92c83d753090b1eed40fdaeb75e93507f25986632f02202de8a38ca7dde19daac18d63e75656bb38e26b6b364210a9cb4a90702fd9483a014752210265a449dd92e864314b0d710b81b55d199469075499a977cb4a3b27ad0ef7361d2103ab00d8858a09aabb3b89618a0436655ffb35b6db38b309bf85ba95cdc28c86b552ae00000000",
  "txid": "9ef905ffb538cd17d90bf8db03f0a4a0cc4bd25567ae9522b7f078b1925f416b",
  "hash": "816ac1dae0269461d9387cc09fc0b16e57e8ec94eb1e567ea46606ed791d79c3",
  "size": 337,
  "vsize": 171,
  "version": 2,
  "locktime": 0,
  "vin": [
    {
      "txid": "01615107819848fe69e6d8ae6eac3e9d77d44eae573e5fcbb2089f33f92c4f38",
      "vout": 0,
      "scriptSig": {
        "asm": "",
        "hex": ""
      },
      "txinwitness": [
        "",
        "3045022100a155c81b10094e96d93c69bcd9b61699f868695f9440b7dd67120b283db73a4d02203d42780901ca8973581c77828f31d53a098fc156d9bb9eaf9975fb64fd90fb0d01",
        "304502210099f459853ca4842620735d92c83d753090b1eed40fdaeb75e93507f25986632f02202de8a38ca7dde19daac18d63e75656bb38e26b6b364210a9cb4a90702fd9483a01",
        "52210265a449dd92e864314b0d710b81b55d199469075499a977cb4a3b27ad0ef7361d2103ab00d8858a09aabb3b89618a0436655ffb35b6db38b309bf85ba95cdc28c86b552ae"
      ],
      "sequence": 4294967295
    }
  ],
  "vout": [
    {
      "value": 0.00092440,
      "n": 0,
      "scriptPubKey": {
        "asm": "OP_HASH160 263b1d6374401a866058a8f57f8cb5448e5aa17a OP_EQUAL",
        "hex": "a914263b1d6374401a866058a8f57f8cb5448e5aa17a87",
        "reqSigs": 1,
        "type": "scripthash",
        "addresses": [
          "2MvjNUwaFcsxkbYCGQVBDVKePMYYCLrsj9w"
        ]
      }
    },
    {
      "value": 0.00884320,
      "n": 1,
      "scriptPubKey": {
        "asm": "OP_HASH160 871ad3b80984c5c1e475e9c3558b4cf0ae4d0461 OP_EQUAL",
        "hex": "a914871ad3b80984c5c1e475e9c3558b4cf0ae4d046187",
        "reqSigs": 1,
        "type": "scripthash",
        "addresses": [
          "2N5ZbM9yarJ1vtvsBNqG7NwQ1DtLz5vgNdn"
        ]
      }
    }
  ],
  "blockhash": "17522b53f67eebcae424371242e0f02dc7680e9bbb81bc3dd32be0f59e26b4c3",
  "confirmations": 10,
  "time": 1482118260,
  "blocktime": 1482118260
}
